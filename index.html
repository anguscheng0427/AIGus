<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <title>Whisper è½‰éŒ„å·¥å…· - Colab å•Ÿå‹•å™¨</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --google-blue: #4285F4;
            --google-blue-hover: #357ae8;
            --google-yellow: #f4b400;
            --google-yellow-hover: #f2a600;
            --text-primary: #333;
            --text-secondary: #5f6368;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --border-color: #dfe1e5;
            --status-bg: #f1f3f4;
            --status-success: #e6f4ea;
            --status-error: #fce8e6;
            --input-bg: #f1f3f4;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", "Helvetica Neue", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 20px;
            box-sizing: border-box;
        }

        .container {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            border: 1px solid var(--border-color);
            padding: 2.5rem;
            max-width: 600px;
            width: 100%;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .logo {
            font-size: 3rem;
            line-height: 1;
            margin-bottom: 1rem;
        }

        h1 {
            color: var(--text-primary);
            font-size: 1.75rem;
            margin: 0;
        }

        p {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s ease;
            width: 100%;
            box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒæ’çˆ†å¯¬åº¦ */
        }

        .button svg {
            margin-right: 12px;
            width: 20px;
            height: 20px;
        }

        .button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .g-btn {
            background-color: var(--google-blue);
            color: white;
        }
        .g-btn:hover:not(:disabled) {
            background-color: var(--google-blue-hover);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .launch-btn {
            background-color: var(--google-yellow);
            color: #333;
            margin-top: 1.5rem; /* èˆ‡è¡¨å–®åˆ†éš” */
        }
        .launch-btn:hover:not(:disabled) {
            background-color: var(--google-yellow-hover);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        #status {
            background-color: var(--status-bg);
            border: 1px solid var(--border-color);
            padding: 12px;
            border-radius: 5px;
            margin-top: 1.5rem;
            font-family: monospace;
            font-size: 0.9rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #status.status-info { background-color: var(--status-bg); }
        #status.status-success { background-color: var(--status-success); color: #1e8e3e; }
        #status.status-error { background-color: var(--status-error); color: #d93025; }
        #status.status-loading {
            background-color: #e8f0fe; /* Google Blue light */
            color: #1967d2;
        }
        
        .loader {
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- æ–°å¢çš„è¡¨å–®æ¨£å¼ --- */
        #config_form {
            display: none; /* é è¨­éš±è— */
            margin-top: 2rem;
            text-align: left;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        /* åœ¨å°è¢å¹•ä¸Šè®Šç‚ºå–®æ¬„ */
        @media (max-width: 600px) {
            .form-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .form-group select,
        .form-group input {
            font-size: 1rem;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            width: 100%;
            box-sizing: border-box;
        }
        .form-group select:focus,
        .form-group input:focus {
            outline: 2px solid var(--google-blue);
            background-color: var(--card-bg);
            border-color: var(--google-blue);
        }

        .form-group.full-width {
            grid-column: 1 / -1; /* ä½”æ»¿æ•´è¡Œ */
        }
        
        hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 1.5rem 0;
        }
        
        footer {
            margin-top: 2rem;
            font-size: 0.8rem;
            color: #aaa;
            text-align: center;
        }

        footer a {
            color: #999;
            text-decoration: none;
        }
        footer a:hover {
            color: var(--text-primary);
        }

    </style>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</head>
<body>

    <div class="container">
        <header>
            <div class="logo">ğŸ™ï¸</div>
            <h1>Whisper è½‰éŒ„å·¥å…·</h1>
        </header>

        <main>
            <p>æœ¬å·¥å…·å°‡åœ¨æ‚¨è‡ªå·±çš„ Google Colab ç’°å¢ƒä¸­åŸ·è¡Œ Whisperã€‚è«‹å…ˆç™»å…¥ï¼Œä¸¦è¨­å®šè½‰éŒ„åƒæ•¸ã€‚</p>

            <button id="authorize_button" class="button g-btn">
                <svg viewBox="0 0 48 48">
                    <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path>
                    <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path>
                    <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path>
                    <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path>
                    <path fill="none" d="M0 0h48v48H0z"></path>
                </svg>
                1. ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
            </button>
            
            <form id="config_form">
                <hr>
                <h2>2. è½‰éŒ„åƒæ•¸è¨­å®š</h2>
                <div class="form-grid">
                    
                    <div class="form-group">
                        <label for="model_select">æ¨¡å‹ (Model)</label>
                        <select id="model_select">
                            <option value="large-v3">large-v3 (æ¨è–¦)</option>
                            <option value="large-v2">large-v2</option>
                            <option value="large">large</option>
                            <option value="medium">medium</option>
                            <option value="small">small</option>
                            <option value="base">base</option>
                            <option value="tiny">tiny</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="lang_select">èªè¨€ (Language)</label>
                        <select id="lang_select">
                            <option value="Chinese">ä¸­æ–‡ (Chinese)</option>
                            <option value="English">è‹±æ–‡ (English)</option>
                            <option value="">è‡ªå‹•åµæ¸¬ (Auto)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="task_select">ä»»å‹™ (Task)</label>
                        <select id="task_select">
                            <option value="transcribe">èªéŸ³è½‰æ–‡å­— (transcribe)</option>
                            <option value="translate">ç¿»è­¯æˆè‹±æ–‡ (translate)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="format_select">è¼¸å‡ºæ ¼å¼ (Format)</label>
                        <select id="format_select">
                            <option value="all">æ‰€æœ‰æ ¼å¼ (all)</option>
                            <option value="txt">ç´”æ–‡å­— (txt)</option>
                            <option value="srt">å­—å¹• (srt)</option>
                            <option value="vtt">å­—å¹• (vtt)</option>
                            <option value="tsv">TSV</option>
                            <option value="json">JSON</option>
                        </select>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="output_dir_input">è¼¸å‡ºè³‡æ–™å¤¾ (Output Dir)</label>
                        <input type="text" id="output_dir_input" value="./result" placeholder="ç•™ç©ºå‰‡è¼¸å‡ºåœ¨ç•¶å‰è³‡æ–™å¤¾">
                    </div>

                    <div class="form-group full-width">
                        <label for="device_select">åŸ·è¡Œè£ç½® (Device)</label>
                        <select id="device_select">
                            <option value="cuda">GPU (T4 æ¨è–¦)</option>
                            <option value="cpu">CPU (é€Ÿåº¦æ…¢)</option>
                        </select>
                    </div>

                </div>
            </form>
            
            <button id="create_button" class="button launch-btn" style="display:none;">
                <svg viewBox="0 0 32 32" fill="currentColor">
                    <path d="M16,2.5c-0.3,0-0.6,0-0.9,0.1C13.8,2.8,12.5,3.4,11.3,4.1C7.3,6.5,4.1,10.7,4.1,15.4c0,0.2,0,0.5,0,0.7c0,0.3,0,0.6,0.1,0.9c0.2,1.3,0.8,2.6,1.5,3.8c2.4,4,6.6,7.2,11.3,7.2c0.2,0,0.5,0,0.7,0c0.3,0,0.6,0,0.9-0.1c1.3-0.2,2.6-0.8,3.8-1.5c4-2.4,7.2-6.6,7.2-11.3c0-0.2,0-0.5,0-0.7c0-0.3,0-0.6-0.1-0.9c-0.2-1.3-0.8-2.6-1.5-3.8C25.7,6.5,21.5,3.3,16.8,3.3C16.5,3.3,16.2,3.3,16,3.3C16,2.9,16,2.7,16,2.5z M16.4,26.5c-4,0-7.4-2.2-9.1-5.3c-0.6-1-0.9-2.1-1.1-3.2c-0.1-0.5-0.1-1-0.1-1.5c0-0.5,0-1,0.1-1.5c0.1-1.1,0.5-2.2,1.1-3.2C8.9,8.7,12.3,6.5,16.4,6.5c1.1,0,2.2,0.3,3.2,0.9c1,0.6,1.9,1.4,2.6,2.3c0.7,0.9,1.3,1.9,1.7,3c0.1,0.2,0.2,0.5,0.2,0.8c0.3,1,0.4,2,0.4,3c0,0.5,0,1-0.1,1.5c-0.1,1.1-0.5,2.2-1.1,3.2c-1.8,3.1-5.1,5.3-9.1,5.3C16.6,26.5,16.5,26.5,16.4,26.5z"></path>
                    <path d="M12.9,10.1c-0.5-0.3-1.1-0.2-1.4,0.3c-0.3,0.5-0.2,1.1,0.3,1.4c1,0.6,1.6,1.7,1.6,2.8c0,1.1-0.6,2.2-1.6,2.8c-0.5,0.3-0.6,0.9-0.3,1.4c0.2,0.4,0.6,0.5,1,0.5c0.2,0,0.3,0,0.5-0.1c1.5-0.9,2.5-2.5,2.5-4.2C15.4,12.6,14.4,11,12.9,10.1z"></path>
                    <path d="M19.1,10.1c-1.5,0.9-2.5,2.5-2.5,4.2c0,1.7,1,3.3,2.5,4.2c0.2,0.1,0.3,0.1,0.5,0.1c0.4,0,0.8-0.2,1-0.5c0.3-0.5,0.2,1.1-0.3-1.4c-1-0.6-1.6-1.7-1.6-2.8c0-1.1,0.6-2.2,1.6-2.8c0.5-0.3,0.6-0.9,0.3-1.4C19.9,10.3,19.6,10.2,19.1,10.1z"></path>
                </svg>
                3. å»ºç«‹ä¸¦å•Ÿå‹•è½‰éŒ„ç­†è¨˜æœ¬
            </button>
            
            <div id="status" class="status-info">ç‹€æ…‹ï¼šç­‰å¾…ç™»å…¥...</div>
        </main>

        <footer>
            <a href="https://github.com/openai/whisper" target="_blank" rel="noopener noreferrer">Whisper</a> &bull; 
            <a href="https://colab.research.google.com/" target="_blank" rel="noopener noreferrer">Google Colab</a> &bull; 
            <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub Pages</a>
        </footer>
    </div>

    <script>
        // =========================================================================
        // è¨­å®šå€ï¼šè«‹å¡«å…¥æ‚¨çš„ Google API æ†‘è­‰
        // =========================================================================
        
        // 1. æ›¿æ›æˆæ‚¨åœ¨ Google Cloud Console å–å¾—çš„ Client ID
        const CLIENT_ID = '948448508017-piu3l6tiqum3n28hivbqg3al6n8c0api.apps.googleusercontent.com'; 
        
        // 2. é€™æ˜¯ Google Drive API çš„æ¬Šé™ç¯„åœ (scope)
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        
        // =========================================================================
        // (Part 2) Colab ç­†è¨˜æœ¬æ¨¡æ¿ (å„²å­˜ç‚º JSON ç‰©ä»¶)
        // *** é€™æ˜¯æœ€æ–°çš„ã€Œå–®ä¸€æŒ‰éˆ•ã€ç°¡åŒ–ç‰ˆ ***
        // *** æ³¨æ„ï¼šç¬¬ä¸€å€‹ cell (è¨­å®šæª”) å°‡ç”± JS å‹•æ…‹æ’å…¥ ***
        // =========================================================================
        const COLAB_NOTEBOOK_TEMPLATE = {
            "nbformat": 4,
            "nbformat_minor": 0,
            "metadata": {
                "colab": {
                    "name": "Whisper è½‰éŒ„ç­†è¨˜æœ¬ (è‡ªå‹•ç”¢ç”Ÿ)",
                    "provenance": []
                },
                "kernelspec": {
                    "name": "python3",
                    "display_name": "Python 3"
                },
                "language_info": {
                    "name": "python"
                }
            },
            "cells": [
                {
                    "cell_type": "markdown",
                    "metadata": { "id": "intro-md" },
                    "source": [
                        "# Whisper èªéŸ³è½‰éŒ„å·¥å…· (å–®ä¸€æŒ‰éˆ•ç‰ˆ)\n\n",
                        "æ‚¨çš„åƒæ•¸ï¼ˆæ¨¡å‹ã€èªè¨€ç­‰ï¼‰å·²ç¶“å¾å•Ÿå‹•ç¶²é è¼‰å…¥ã€‚\n\n",
                        "**é‡è¦æç¤ºï¼š** ç‚ºäº†ç²å¾—æœ€ä½³ï¼ˆå…è²»ï¼‰è½‰éŒ„é€Ÿåº¦ï¼Œè«‹å…ˆè¨­å®š GPUï¼š\n\n",
                        "1.  é»æ“Šé ‚ç«¯é¸å–®çš„ã€Œ**åŸ·è¡Œéšæ®µ**ã€(Runtime)\n",
                        "2.  é¸æ“‡ã€Œ**è®Šæ›´åŸ·è¡Œéšæ®µé¡å‹**ã€(Change runtime type)\n",
                        "3.  åœ¨ã€Œç¡¬é«”åŠ é€Ÿå™¨ã€ä¸‹æ‹‰é¸å–®ä¸­ï¼Œé¸æ“‡ã€Œ**T4 GPU**ã€\n",
                        "4.  é»æ“Šã€Œ**å„²å­˜**ã€\n\n",
                        "--- \n",
                        "### ğŸš€ é–‹å§‹åŸ·è¡Œ\n\n",
                        "**è«‹é»æ“Šä¸‹æ–¹å„²å­˜æ ¼å·¦å´çš„ã€Œæ’­æ”¾ã€æŒ‰éˆ•**ï¼Œå³å¯ä¾åºå®Œæˆï¼š\n",
                        "1.  å®‰è£ Whisper å‡½å¼åº«\n",
                        "2.  è·³å‡ºè¦–çª—è®“æ‚¨ä¸Šå‚³éŸ³æª”\n",
                        "3.  ä¾ç…§æ‚¨è¨­å®šçš„åƒæ•¸åŸ·è¡Œè½‰éŒ„"
                    ]
                },
                {
                    "cell_type": "code",
                    "metadata": { "id": "run-all-cell", "colab": {} },
                    "source": [
                        "import os\n",
                        "from google.colab import files\n\n",
                        "# --- æ­¥é©Ÿ 1ï¼šå®‰è£ Whisper ---\n",
                        "print(\"--- æ­¥é©Ÿ 1/3ï¼šæ­£åœ¨å®‰è£ Whisper... ---\")\n",
                        "!pip install git+https://github.com/openai/whisper.git > /dev/null\n",
                        "print(\"Whisper å®‰è£å®Œæˆã€‚\\n\")\n\n",
                        
                        "# --- æ­¥é©Ÿ 2ï¼šä¸Šå‚³æª”æ¡ˆ ---\n",
                        "print(\"--- æ­¥é©Ÿ 2/3ï¼šè«‹ä¸Šå‚³æ‚¨çš„éŸ³æª” --- (è«‹åœ¨ä¸‹æ–¹è·³å‡ºçš„è¦–çª—é¸å–æª”æ¡ˆ)\")\n",
                        "uploaded = files.upload()\n\n",
                        
                        "if not uploaded:\n",
                        "    print(\"\\néŒ¯èª¤ï¼šæ‚¨æ²’æœ‰ä¸Šå‚³ä»»ä½•æª”æ¡ˆã€‚è«‹é‡æ–°åŸ·è¡Œæ­¤å„²å­˜æ ¼ã€‚\")\n",
                        "else:\n",
                        "    filename = next(iter(uploaded))\n",
                        "    print(f\"\\næˆåŠŸä¸Šå‚³ï¼š {filename}\\n\")\n\n",
                        
                        "    # --- æ­¥é©Ÿ 3ï¼šåŸ·è¡Œè½‰éŒ„ ---\n",
                        "    # åƒæ•¸ (MODEL, LANGUAGE ç­‰) å·²åœ¨ç¬¬ä¸€å€‹éš±è—å„²å­˜æ ¼ä¸­å®šç¾©\n",
                        "    print(\"--- æ­¥é©Ÿ 3/3ï¼šæ­£åœ¨çµ„åˆæŒ‡ä»¤ä¸¦é–‹å§‹è½‰éŒ„... ---\")\n",
                        "    print(f\"ä½¿ç”¨æ¨¡å‹: {MODEL}, èªè¨€: {'è‡ªå‹•åµæ¸¬' if not LANGUAGE else LANGUAGE}, ä»»å‹™: {TASK}\")\n\n",
                        
                        "    # çµ„åˆ Whisper æŒ‡ä»¤\n",
                        "    cmd = f'whisper \"{filename}\" --model {MODEL} --task {TASK} --output_format {OUTPUT_FORMAT}'\n",
                        "    \n",
                        "    if LANGUAGE:\n",
                        "        cmd += f' --language \"{LANGUAGE}\"'\n",
                        "    \n",
                        "    if OUTPUT_DIR:\n",
                        "        cmd += f' --output_dir \"{OUTPUT_DIR}\"'\n",
                        "        os.makedirs(OUTPUT_DIR, exist_ok=True)\n",
                        "\n",
                        "    if DEVICE == \"cpu\":\n",
                        "        cmd += \" --device cpu --fp16 False\"\n",
                        "    else:\n",
                        "        cmd += \" --device cuda\" # é è¨­ä½¿ç”¨ Colab GPU\n",
                        "\n",
                        "    print(f\"\\nå³å°‡åŸ·è¡ŒæŒ‡ä»¤ï¼š\\n{cmd}\\n\")\n",
                        "    print(\"--- é–‹å§‹åŸ·è¡Œ Whisper (è«‹ç¨å€™ï¼Œä¸‹è¼‰æ¨¡å‹å¯èƒ½éœ€è¦å¹¾åˆ†é˜) ---\")\n",
                        "    \n",
                        "    # åŸ·è¡ŒæŒ‡ä»¤\n",
                        "    try:\n",
                        "        get_ipython().system(cmd)\n",
                        "        print(\"\\n--- è½‰éŒ„åŸ·è¡Œå®Œç•¢ ---\")\n",
                        "        if OUTPUT_DIR:\n",
                        "            print(f\"âœ… æˆåŠŸï¼æª”æ¡ˆå·²å„²å­˜æ–¼å·¦å´æª”æ¡ˆåˆ—è¡¨çš„ {OUTPUT_DIR} è³‡æ–™å¤¾ä¸­ã€‚\")\n",
                        "        else:\n",
                        "             print(\"âœ… æˆåŠŸï¼æª”æ¡ˆå·²å„²å­˜æ–¼å·¦å´æª”æ¡ˆåˆ—è¡¨ä¸­ã€‚\")\n",
                        "    except Exception as e:\n",
                        "        print(f\"åŸ·è¡Œ Whisper æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{e}\")\n"
                    ],
                    "execution_count": null,
                    "outputs": []
                }
            ]
        };
        // =========================================================================
        // Google API é©—è­‰èˆ‡æ“ä½œ (å·²æ›´æ–° status å‡½å¼)
        // =========================================================================

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        const authButton = document.getElementById('authorize_button');
        const configForm = document.getElementById('config_form');
        const createButton = document.getElementById('create_button');
        const statusDiv = document.getElementById('status');
        
        // è¡¨å–®å…ƒç´ 
        const model_select = document.getElementById('model_select');
        const lang_select = document.getElementById('lang_select');
        const task_select = document.getElementById('task_select');
        const format_select = document.getElementById('format_select');
        const output_dir_input = document.getElementById('output_dir_input');
        const device_select = document.getElementById('device_select');


        authButton.onclick = handleAuthClick;
        createButton.onclick = handleCreateClick;

        /**
         * æ›´æ–°ç‹€æ…‹é¡¯ç¤º (æ–°çš„å‡½å¼)
         * @param {string} text é¡¯ç¤ºçš„æ–‡å­—
         * @param {'info' | 'success' | 'error' | 'loading'} type ç‹€æ…‹é¡å‹
         */
        function updateStatus(text, type = 'info') {
            statusDiv.className = `status-${type}`;
            
            if (type === 'loading') {
                statusDiv.innerHTML = `<span class="loader"></span> ${text}`;
            } else {
                statusDiv.textContent = text;
            }
        }


        // æ­¥é©Ÿ 1: gapi (Google API Client) è¼‰å…¥å®Œæˆ
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        // æ­¥é©Ÿ 2: åˆå§‹åŒ– gapi client
        async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
            });
            gapiInited = true;
            checkReadyState();
        }

        // æ­¥é©Ÿ 3: gis (Google Identity Services) è¼‰å…¥å®Œæˆ
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // æˆ‘å€‘å°‡åœ¨ handleAuthClick ä¸­è™•ç†å›å‘¼
            });
            gisInited = true;
            checkReadyState();
        }

        // æ­¥é©Ÿ 4: æª¢æŸ¥å…©å€‹å‡½å¼åº«æ˜¯å¦éƒ½å·²è¼‰å…¥
        function checkReadyState() {
            if (gapiInited && gisInited) {
                updateStatus('ç‹€æ…‹ï¼šAPI è¼‰å…¥å®Œæˆï¼Œè«‹ç™»å…¥ã€‚', 'info');
            }
        }

        // æ­¥é©Ÿ 5: è™•ç†ã€Œç™»å…¥ã€æŒ‰éˆ•é»æ“Š
        function handleAuthClick() {
            if (CLIENT_ID === 'YOUR_CLIENT_ID_GOES_HERE') {
                alert('éŒ¯èª¤ï¼šæ‚¨å°šæœªåœ¨ index.html ç¨‹å¼ç¢¼ä¸­å¡«å…¥æ‚¨çš„ Client IDï¼');
                updateStatus('éŒ¯èª¤ï¼šå°šæœªè¨­å®š Client IDã€‚', 'error');
                return;
            }
            tokenClient.callback = async (resp) => {
                if (resp.error) {
                    throw (resp);
                }
                updateStatus('ç‹€æ…‹ï¼šç™»å…¥æˆåŠŸï¼è«‹è¨­å®šåƒæ•¸ã€‚', 'success');
                authButton.style.display = 'none'; // éš±è—ç™»å…¥æŒ‰éˆ•
                configForm.style.display = 'block'; // é¡¯ç¤ºè¨­å®šè¡¨å–®
                createButton.style.display = 'inline-flex'; // é¡¯ç¤ºå»ºç«‹æŒ‰éˆ•
                createButton.disabled = false;
            };
            
            // è«‹æ±‚æ¬Šæ–
            tokenClient.requestAccessToken();
        }

        // æ­¥é©Ÿ 6: è™•ç†ã€Œå»ºç«‹ä¸¦å•Ÿå‹•ã€æŒ‰éˆ•é»æ“Š
        async function handleCreateClick() {
            try {
                updateStatus('ç‹€æ…‹ï¼šæ­£åœ¨è®€å–è¨­å®šä¸¦å»ºç«‹ç­†è¨˜æœ¬...', 'loading');
                createButton.disabled = true;

                // --- é€™æ˜¯æ–°çš„æ ¸å¿ƒé‚è¼¯ ---
                // 1. è®€å– HTML è¡¨å–®ä¸­çš„æ‰€æœ‰è¨­å®šå€¼
                const model = model_select.value;
                const language = lang_select.value;
                const task = task_select.value;
                const output_format = format_select.value;
                const output_dir = output_dir_input.value.trim();
                const device = device_select.value;
                
                // 2. å»ºç«‹ä¸€å€‹ Python ç¨‹å¼ç¢¼å­—ä¸²ï¼Œç”¨ä¾†å®šç¾©é€™äº›è®Šæ•¸
                // æ³¨æ„ï¼šPython å­—ä¸²éœ€è¦ç”¨å¼•è™Ÿæ‹¬èµ·ä¾†ï¼Œæ‰€ä»¥æˆ‘å€‘åœ¨ JS ä¸­è¦è™•ç† "
                const configCode = `
# --- ç”±å•Ÿå‹•å™¨è‡ªå‹•ç”¢ç”Ÿçš„è¨­å®š (Auto-generated settings) ---
MODEL = "${model}"
LANGUAGE = "${language}"
TASK = "${task}"
OUTPUT_FORMAT = "${output_format}"
OUTPUT_DIR = "${output_dir}"
DEVICE = "${device}"
# ----------------------------------------------------
`;
                // 3. å»ºç«‹é€™å€‹è¨­å®šæª”çš„ Colab å„²å­˜æ ¼ (cell)
                const configCell = {
                    "cell_type": "code",
                    "metadata": { 
                        "id": "config-cell-autogen",
                        "colab": { "jupyter": { "source_hidden": true } } // é è¨­æ‘ºç–Šæ­¤å„²å­˜æ ¼
                    },
                    "source": configCode.trim().split('\n'), // è½‰æ›ç‚º Colab æ¥å—çš„è¡Œé™£åˆ—
                    "execution_count": null,
                    "outputs": []
                };

                // 4. å–å¾—ç­†è¨˜æœ¬æ¨¡æ¿ï¼Œä¸¦å°‡è¨­å®š cell æ’å…¥åˆ°æœ€å‰é¢
                // **é‡è¦**ï¼šæˆ‘å€‘ä½¿ç”¨ deep copy (JSON.parse/stringify) ç¢ºä¿æ¨¡æ¿ä¸è¢«æ°¸ä¹…ä¿®æ”¹
                let notebookContent = JSON.parse(JSON.stringify(COLAB_NOTEBOOK_TEMPLATE));
                notebookContent.cells.unshift(configCell);
                
                // 5. å°‡ä¿®æ”¹å¾Œçš„ç­†è¨˜æœ¬å…§å®¹è½‰æ›ç‚ºå­—ä¸²
                const notebookString = JSON.stringify(notebookContent);
                
                // --- èˆŠçš„ Drive API é‚è¼¯ (ä¸Šå‚³æª”æ¡ˆ) ---
                const boundary = '-------314159265358979323846';
                const delimiter = "\r\n--" + boundary + "\rn";
                const close_delim = "\r\n--" + boundary + "--";

                const metadata = {
                    'name': `Whisper è½‰éŒ„ç­†è¨˜æœ¬ (${model}).ipynb`, // æª”åå¯ä»¥åŒ…å«æ¨¡å‹
                    'mimeType': 'application/vnd.google.colab' 
                };

                const requestBody =
                    delimiter +
                    'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
                    JSON.stringify(metadata) +
                    delimiter +
                    'Content-Type: application/x-ipynb+json\r\n\r\n' +
                    notebookString +
                    close_delim;

                // å‘¼å« Google Drive API (files.create)
                const response = await gapi.client.request({
                    'path': 'https://www.googleapis.com/upload/drive/v3/files',
                    'method': 'POST',
                    'params': { 'uploadType': 'multipart' },
                    'headers': {
                        'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                    },
                    'body': requestBody
                });

                const file = response.result;
                const fileId = file.id;
                
                updateStatus(`ç‹€æ…‹ï¼šç­†è¨˜æœ¬å»ºç«‹æˆåŠŸï¼æ­£åœ¨ç‚ºæ‚¨é–‹å•Ÿ Colab...`, 'success');
                
                // åœ¨æ–°åˆ†é ä¸­é–‹å•Ÿ Colab
                const colabUrl = `https://colab.research.google.com/drive/${fileId}`;
                window.open(colabUrl, '_blank');
                
                createButton.disabled = false;

            } catch (error) {
                console.error(error);
                let errorMsg = error.message || error.result?.error?.message || 'æœªçŸ¥éŒ¯èª¤';
                updateStatus(`éŒ¯èª¤ï¼š ${errorMsg}`, 'error');
                createButton.disabled = false;
            }
        }
    </script>

</body>
</html>